#!/bin/bash

# Set PATH to include common locations
export PATH="/opt/homebrew/bin:/usr/local/bin:$(go env GOPATH)/bin:$PATH"

echo "üîç Running pre-commit checks..."

# Get all staged .go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$')

if [ -z "$STAGED_GO_FILES" ]; then
    echo "‚úÖ No Go files to check"
    exit 0
fi

# Run go fmt (from repo root)
echo "üìù Running go fmt..."
gofmt -w $STAGED_GO_FILES
git add $STAGED_GO_FILES

# Change to backend directory for go commands
cd backend || exit 1

GOLANGCI_LINT_VERSION="v1.64.8"

if ! golangci-lint version 2>&1 | grep -q "$GOLANGCI_LINT_VERSION"; then
    echo "üì¶ Installing golangci-lint $GOLANGCI_LINT_VERSION..."
    go install github.com/golangci/golangci-lint/cmd/golangci-lint@$GOLANGCI_LINT_VERSION
fi

# Run golangci-lint
echo "üîç Running golangci-lint..."
if ! command -v golangci-lint &> /dev/null; then
    echo "‚ö†Ô∏è  golangci-lint not found. Install it with:"
    echo "   brew install golangci-lint"
    echo "   OR go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
    exit 1
fi

golangci-lint run
if [ $? -ne 0 ]; then
    echo "‚ùå golangci-lint failed"
    exit 1
fi

# Run go mod tidy
echo "üßπ Running go mod tidy..."
go mod tidy
git add go.mod go.sum

echo "‚úÖ All checks passed!"
exit 0